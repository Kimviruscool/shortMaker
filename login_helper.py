import time
import os
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager


def update_cookies_file(output_file="cookies.txt"):
    """
    ë¸Œë¼ìš°ì €ë¥¼ ì—´ì–´ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ê²Œ í•œ ë’¤,
    ì¿ í‚¤ë¥¼ ì¶”ì¶œí•˜ì—¬ Netscape í¬ë§·(cookies.txt)ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
    """
    print("=" * 60)
    print("ğŸ” ìœ íŠœë¸Œ ë¡œê·¸ì¸ ë„êµ¬ (Selenium)")
    print("   1. ë¸Œë¼ìš°ì €ê°€ ì—´ë¦¬ë©´ 'ê¹¡í†µ ê³„ì •'ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.")
    print("   2. ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ë©´ í”„ë¡œê·¸ë¨ì´ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ì°½ì„ ë‹«ìŠµë‹ˆë‹¤.")
    print("=" * 60)

    # 1. ë¸Œë¼ìš°ì € ì˜µì…˜ ì„¤ì • (ë´‡ íƒì§€ ìµœì†Œí™”)
    options = webdriver.ChromeOptions()
    options.add_argument("--disable-blink-features=AutomationControlled")
    options.add_experimental_option("excludeSwitches", ["enable-automation"])
    options.add_experimental_option("useAutomationExtension", False)

    # 2. ë¸Œë¼ìš°ì € ì‹¤í–‰
    service = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=service, options=options)

    try:
        driver.get("https://www.youtube.com")
        print("â³ ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘... (ë¸Œë¼ìš°ì €ì—ì„œ ë¡œê·¸ì¸ì„ ì§„í–‰í•´ì£¼ì„¸ìš”)")

        # 3. ë¡œê·¸ì¸ ê°ì§€ ë£¨í”„
        while True:
            cookies = driver.get_cookies()
            # 'LOGIN_INFO' ì¿ í‚¤ê°€ ìƒê¸°ë©´ ë¡œê·¸ì¸ëœ ê²ƒìœ¼ë¡œ íŒë‹¨
            is_logged_in = any(cookie['name'] == 'LOGIN_INFO' for cookie in cookies)

            if is_logged_in:
                print("âœ… ë¡œê·¸ì¸ ê°ì§€ë¨! 3ì´ˆ í›„ ì¿ í‚¤ë¥¼ ì €ì¥í•©ë‹ˆë‹¤...")
                time.sleep(3)  # ì¿ í‚¤ê°€ ì™„ì „íˆ ì„¸íŒ…ë˜ë„ë¡ ì ì‹œ ëŒ€ê¸°
                break

            time.sleep(2)

        # 4. Netscape í¬ë§·ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write("# Netscape HTTP Cookie File\n")
            f.write("# This file is generated by login_helper.py\n\n")

            for cookie in driver.get_cookies():
                # Netscape í¬ë§·: domain flag path secure expiration name value
                domain = cookie.get('domain', '')
                # ë„ë©”ì¸ì´ .ìœ¼ë¡œ ì‹œì‘í•˜ë©´ TRUE, ì•„ë‹ˆë©´ FALSE
                flag = 'TRUE' if domain.startswith('.') else 'FALSE'
                path = cookie.get('path', '/')
                secure = 'TRUE' if cookie.get('secure') else 'FALSE'
                # ë§Œë£Œì‹œê°„ì´ ì—†ìœ¼ë©´ 1ë…„ ë’¤ë¡œ ì„¤ì •
                expiration = int(cookie.get('expiry', time.time() + 3600 * 24 * 365))
                name = cookie.get('name', '')
                value = cookie.get('value', '')

                f.write(f"{domain}\t{flag}\t{path}\t{secure}\t{expiration}\t{name}\t{value}\n")

        print(f"ğŸ“‚ ì¿ í‚¤ íŒŒì¼ ìƒì„± ì™„ë£Œ: {os.path.abspath(output_file)}")

    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
    finally:
        driver.quit()


if __name__ == "__main__":
    update_cookies_file()