# ì°¨ë‹¨ ë°©ì§€ìš©

import os
import time
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager


class CookieManager:
    def __init__(self):
        # í”„ë¡œì íŠ¸ ìµœìƒìœ„ í´ë” ê²½ë¡œ ì°¾ê¸°
        current_dir = os.path.dirname(os.path.abspath(__file__))  # Detour í´ë”
        self.project_root = os.path.dirname(os.path.dirname(current_dir))  # shortMaker í´ë”
        self.cookie_filename = "cookies.txt"
        self.cookie_path = os.path.join(self.project_root, self.cookie_filename)

    def get_cookie_path(self):
        """
        ì¿ í‚¤ íŒŒì¼ ê²½ë¡œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        íŒŒì¼ì´ ì—†ìœ¼ë©´ -> ìë™ìœ¼ë¡œ ë¸Œë¼ìš°ì €ë¥¼ ë„ì›Œ ë¡œê·¸ì¸ì„ ìœ ë„í•˜ê³  íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
        """
        if os.path.exists(self.cookie_path):
            # 1. ì´ë¯¸ ì¿ í‚¤ê°€ ìˆëŠ” ê²½ìš°
            # print(f"ğŸª [Cookie] ê¸°ì¡´ ì¿ í‚¤ ì‚¬ìš©: {self.cookie_path}")
            return self.cookie_path
        else:
            # 2. ì¿ í‚¤ê°€ ì—†ëŠ” ê²½ìš° -> ë´‡ ì‹¤í–‰
            print(f"âš ï¸ [Cookie] ì¿ í‚¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")
            success = self._run_selenium_login()

            if success:
                return self.cookie_path
            else:
                return None

    def _run_selenium_login(self):
        """
        (ë‚´ë¶€ í•¨ìˆ˜) ì…€ë ˆë‹ˆì›€ ë¸Œë¼ìš°ì €ë¥¼ ë„ì›Œ ì¿ í‚¤ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
        """
        print("ğŸ¤– [Bot] ë¡œê·¸ì¸ ë´‡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤...")
        print("ğŸš€ [í•„ìˆ˜] ë¸Œë¼ìš°ì €ê°€ ëœ¨ë©´ 60ì´ˆ ì•ˆì— 'êµ¬ê¸€ ë¡œê·¸ì¸'ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!")

        options = Options()
        options.add_argument("--disable-blink-features=AutomationControlled")
        options.add_argument(
            "user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")

        try:
            driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)
            driver.get("https://www.youtube.com")

            # 60ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ (ë¡œê·¸ì¸ ëŒ€ê¸°)
            for i in range(60, 0, -1):
                print(f"\râ³ ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘... {i}ì´ˆ ë‚¨ìŒ ", end="")
                time.sleep(1)
            print("\nğŸ¤– [Bot] ì¿ í‚¤ ì¶”ì¶œ ì¤‘...")

            selenium_cookies = driver.get_cookies()

            # Netscape í¬ë§·ìœ¼ë¡œ ì €ì¥
            with open(self.cookie_path, 'w', encoding='utf-8') as f:
                f.write("# Netscape HTTP Cookie File\n")
                f.write("# Generated by ShortMaker\n\n")

                for cookie in selenium_cookies:
                    domain = cookie.get('domain', '')
                    domain_specified = "TRUE" if domain.startswith('.') else "FALSE"
                    path = cookie.get('path', '/')
                    secure = "TRUE" if cookie.get('secure') else "FALSE"
                    expires = int(cookie.get('expiry', time.time() + 3600 * 24 * 365))
                    name = cookie.get('name', '')
                    value = cookie.get('value', '')

                    f.write(f"{domain}\t{domain_specified}\t{path}\t{secure}\t{expires}\t{name}\t{value}\n")

            print(f"\nâœ… [ì„±ê³µ] ì¿ í‚¤ ì €ì¥ ì™„ë£Œ: {self.cookie_path}")
            driver.quit()
            return True

        except Exception as e:
            print(f"\nâŒ [ì˜¤ë¥˜] ë´‡ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            try:
                driver.quit()
            except:
                pass
            return False